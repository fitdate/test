name: Deploy with Zero Downtime

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # 프로젝트 루트 디렉토리로 이동
          cd /home/ubuntu/test
          git pull origin main
          
          # 현재 활성화된 앱 확인
          CURRENT_APP=$(grep -o "blue-app\|green-app" docker/nginx/nginx.conf | head -1)
          
          # 반대 앱으로 배포
          if [ "$CURRENT_APP" = "blue-app" ]; then
            TARGET_APP="green-app"
            CURRENT_PORT="3000"
            TARGET_PORT="3001"
          else
            TARGET_APP="blue-app"
            CURRENT_PORT="3001"
            TARGET_PORT="3000"
          fi
          
          echo "Deploying to $TARGET_APP"
          
          # 대상 앱 빌드 및 재시작 (docker 디렉토리에서 실행)
          cd docker
          docker-compose build $TARGET_APP
          docker-compose up -d $TARGET_APP
          
          # 앱이 준비될 때까지 대기
          echo "Waiting for $TARGET_APP to be ready..."
          sleep 10
          
          # Nginx 설정 업데이트 (현재 docker 디렉토리에 있으므로 상대 경로 사용)
          sed -i "s/$CURRENT_APP/$TARGET_APP/g" nginx/nginx.conf
          
          # Nginx 설정 리로드
          docker-compose exec -T nginx nginx -s reload
          
          echo "Traffic switched to $TARGET_APP"
          
          # 이전 앱 중지 (옵션)
          # docker-compose stop $CURRENT_APP
