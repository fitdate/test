name: Deploy with Zero Downtime

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        script: |
          # 프로젝트 루트 디렉토리로 이동
          cd /home/ubuntu/test
          git reset --hard
          git clean -fd
          git pull origin main
          
          # 현재 활성화된 앱 확인 (파일이 없거나 패턴이 없을 경우 blue-app으로 기본 설정)
          if [ -f "docker/nginx/nginx.conf" ] && grep -q "blue-app\|green-app" docker/nginx/nginx.conf; then
            CURRENT_APP=$(grep -o "blue-app\|green-app" docker/nginx/nginx.conf | head -1)
          else
            CURRENT_APP="blue-app"
            echo "WARN: nginx.conf not found or no app pattern found, defaulting to $CURRENT_APP"
          fi
          
          # 반대 앱으로 배포
          if [ "$CURRENT_APP" = "blue-app" ]; then
            TARGET_APP="green-app"
            CURRENT_PORT="3000"
            TARGET_PORT="3001"
          else
            TARGET_APP="blue-app"
            CURRENT_PORT="3001"
            TARGET_PORT="3000"
          fi
          
          echo "Deploying to $TARGET_APP"
          
          # docker 디렉토리로 이동
          cd docker
          
          # 이미 실행 중인 서비스 확인 (Redis, Postgres는 유지)
          echo "Checking running containers..."
          REDIS_RUNNING=$(docker ps -q -f name=redis-container)
          POSTGRES_RUNNING=$(docker ps -q -f name=postgres-container)
          
          # 선택적으로 서비스 시작 (이미 실행 중인 서비스는 건너뜀)
          echo "Starting required services..."
          
          # Redis가 실행 중이 아니면 시작
          if [ -z "$REDIS_RUNNING" ]; then
            echo "Starting Redis..."
            docker-compose up -d redis
          else
            echo "Redis is already running, skipping..."
          fi
          
          # Postgres가 실행 중이 아니면 시작
          if [ -z "$POSTGRES_RUNNING" ]; then
            echo "Starting Postgres..."
            docker-compose up -d postgres
          else
            echo "Postgres is already running, skipping..."
          fi
          
          # 대상 앱만 빌드하고 시작
          echo "Building and starting $TARGET_APP..."
          docker-compose build $TARGET_APP
          docker-compose up -d $TARGET_APP
          
          # Nginx 확인 및 시작
          if ! docker ps | grep -q nginx-container; then
            echo "Starting nginx service..."
            docker-compose up -d nginx
            sleep 5
          fi
          
          # 앱이 준비될 때까지 대기
          echo "Waiting for $TARGET_APP to be ready..."
          sleep 15
          
          # Nginx 설정 업데이트
          echo "Updating nginx configuration..."
          if [ -f "nginx/nginx.conf" ]; then
            sed -i "s/$CURRENT_APP/$TARGET_APP/g" nginx/nginx.conf
            
            # Nginx 설정 리로드
            if docker ps | grep -q nginx-container; then
              echo "Reloading nginx configuration..."
              docker-compose exec -T nginx nginx -s reload
              echo "Traffic switched to $TARGET_APP"
            else
              echo "ERROR: Nginx container is not running, cannot reload config"
            fi
          else
            echo "ERROR: nginx.conf not found at nginx/nginx.conf"
          fi
          
          echo "Deployment process completed"
